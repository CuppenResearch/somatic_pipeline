# Template for generating RDF triples from SNV1 output (in-house annotation
# pipeline). For more information see bamannotate.md file in doc_central.
#
# Create RDF with for example 
#
#   env INFILE=variants.snv1 erb annotate_snv1.rdf
#
# or full
#
#   env INFILE=test/data/input/snv/example-varscan.snp.snv1 erb ./templates/rdf/annotate_snv1.rdf
#
#   env INFILE=test/data/input/snv/example-varscan.snp.snv1 erb ./templates/rdf/annotate_snv1.rdf > ./test/data/regression/snv/example-varscan.snp.snv1.rdf
#
# Example output: 
#
#  :annotated_snv_1_10338145_G  :chr     "1" .
#  :annotated_snv_1_10338145_G  :pos     10338145 .
#  :annotated_snv_1_10338145_G  :snv     true .
#  :annotated_snv_1_10338145_G  :ref     "A" .
#  :annotated_snv_1_10338145_G  :var     "G" .
#  :annotated_snv_1_10338145_G  :strand  1 .
#  :annotated_snv_1_10338145_G  :gene_name  "KIF1B" .
#  :annotated_snv_1_10338145_G  :snp_id  "novel" .
#  :annotated_snv_1_10338145_G  :effect  :missense_variant .
#  :annotated_snv_1_10338145_G  :gene_id        :ENSG00000054523 .
#  :annotated_snv_1_10338145_G  :tid  :ENST00000377081 .
#  :annotated_snv_1_10338145_G  :protein_id     :ENSP00000366284 .
#  :annotated_snv_1_10338145_G  :polyphen  0.007 .
#   :annotated_snv_1_10338145_G  :sift      1 .

<%= File.read(File.dirname(__FILE__)+'/preamble.rdf')  %>

<%
   id = prev_id = nil
   File.open(ENV["INFILE"]).each_line do |line|
     next if line =~ /^#/
     fields = line.split(/\t/).map{|item| ( item=='NA' ? nil : item ) }
     chr = fields[0]
     pos = fields[1]
     (ref,var) = fields[2].split(/\//)
     (aaref,aavar) = fields[11].split(/\//) if fields[11]
     high_pop_freq = fields[23] if fields[23] 
     #  id = BioRdf::Turtle.mangle_identifier(gene)
     prev_id = id
     id = ':'+['annotated_snv',chr,pos,var].join('_')
     tid = id+'_'+fields[26]
     # First pase info for hints of cancer involvement
     info = fields[30]
     cancer = info =~ /cancer/i
     breast_cancer = info =~ /breast_cancer/i
     ovarian_cancer = info =~ /ovarian_cancer/i
     # Next the COSMIC data
     high_pop = fields[24]
     breast_cancer = true if high_pop =~ /tumour_site:breast/
     ovarian_cancer = true if high_pop =~ /tumour_site:ovary/
     cancer = true if high_pop =~ /tumour/
%>
    <% if id != prev_id %>
    <%= id %>  :chr     "<%= chr %>" ;
        :pos     <%= pos %> ;
        :snv     true ;
        :ref     "<%= ref %>" ;
        :var     "<%= var %>" ;
        <% if aaref %>:aa_ref  "<%= aaref %>" ;<% end %>
        <% if aavar %>:aa_var  "<%= aavar %>" ;<% end %>
        :strand  <%= fields[3] %> ;
        :gene_name  "<%= fields[9] %>" ;
        :snp_id  "<%= fields[12] %>" ;
        :effect  :<%= fields[13] %> ;
        :gene_id        :<%= fields[25] %> .
    <% if high_pop_freq %><%= id %>  :high_pop_freq  <%= high_pop_freq %> .
    <%= id %>  :high_pop  "<%= fields[24] %>" .
    <% if cancer %><%= id %>  :cancer :true .<% end %>
    <% if breast_cancer %><%= id %>  :breast_cancer :true .<% end %>
    <% if ovarian_cancer %><%= id %>  :ovarian_cancer :true .<% end %>
    <% end %>
    <% end %>
    <%= tid %>  :snv_id  <%= id %> .
    <%= tid %>  :tid  :<%= fields[26] %> .
  <% if fields[27] and aaref and fields[16] %>
    <%= tid %>  :protein_id     :<%= fields[27] %> .
    <%= tid %>  :polyphen  <%= fields[16] %> .
    <% if fields[18] %><%= tid %>  :sift      <%= fields[18] %> .
    <% end %>
  <% end %>
<% end %>
